#!/bin/sh

# build Xalan classpath
xalancp='contrib/xalan-j/xalan.jar'
xalancp=${xalancp}':contrib/xalan-j/serializer.jar'
xalancp=${xalancp}':contrib/xalan-j/xml-apis.jar'
xalancp=${xalancp}':contrib/xalan-j/xercesImpl.jar'
xalancp=${xalancp}':contrib/docbook-xsl-ns/extensions/xalan27.jar'

# set Java options
xmlparser='org.apache.xerces.parsers.XIncludeParserConfiguration'

# set up environment
echo 'Setting up environment...'
if [ ! -d build ]; then
	mkdir build
fi
svn export --force src/files build/files

# validate the XML
echo 'Validating document...'
java \
    -Dorg.apache.xerces.xni.parser.XMLParserConfiguration=${xmlparser} \
    -jar contrib/jing/bin/jing.jar \
	contrib/docbook/docbookxi.rng \
	src/help.xml
echo '--------------------'
echo

# DocBook -> XSL-FO -> PDF (letter)
echo 'PDF (letter)'
java -cp ${xalancp}	\
	-Dorg.apache.xerces.xni.parser.XMLParserConfiguration=${xmlparser} \
	org.apache.xalan.xslt.Process \
	-IN src/help.xml \
	-XSL contrib/docbook-xsl-ns/fo/docbook.xsl \
	-OUT build/help-letter.fo
sh contrib/fop/fop build/help-letter.fo build/help-letter-fo.pdf
echo '--------------------'
echo

# DocBook -> XSL-FO -> PDF (A4)
echo 'PDF (A4)'
java -cp ${xalancp}	\
	-Dorg.apache.xerces.xni.parser.XMLParserConfiguration=${xmlparser} \
	org.apache.xalan.xslt.Process \
	-IN src/help.xml \
	-XSL contrib/docbook-xsl-ns/fo/docbook.xsl \
	-OUT build/help-a4.fo
sh contrib/fop/fop build/help-a4.fo build/help-a4-fo.pdf
echo '--------------------'
echo

# DocBook -> LaTeX -> PDF (letter)
echo 'LaTeX PDF (letter)'
dblatex -o build/help-letter-latex.pdf \
	-P latex.class.options=letterpaper \
	src/help.xml
echo '--------------------'
echo

# DocBook -> LaTeX -> PDF (A4)
echo 'LaTeX PDF (A4)'
dblatex -o build/help-a4-latex.pdf \
	-P latex.class.options=a4paper \
	src/help.xml
echo '--------------------'
echo

# DocBook -> HTML (single page)
echo 'HTML (single page)'
java -cp ${xalancp}	\
	-Dorg.apache.xerces.xni.parser.XMLParserConfiguration=${xmlparser} \
	org.apache.xalan.xslt.Process \
	-IN src/help.xml \
	-XSL contrib/docbook-xsl-ns/xhtml-1_1/docbook.xsl \
	-OUT build/help.html
echo '--------------------'
echo

# DocBook -> HTML (multiple pages)
echo 'HTML (multiple pages)'
java -cp ${xalancp}	\
	-Dorg.apache.xerces.xni.parser.XMLParserConfiguration=${xmlparser} \
	org.apache.xalan.xslt.Process \
	-PARAM base.dir ../build/html/ \
	-PARAM img.src.path ../ \
	-IN src/help.xml \
	-XSL contrib/docbook-xsl-ns/xhtml-1_1/chunk.xsl
echo '--------------------'
echo

# move output files
echo 'Collecting output files...'
if [ ! -d output ]; then
	mkdir output
fi
cp -fpR build/*.pdf build/help.html build/html build/files output