function [tt,err,rpt]=testephg(efile,tfile)

% TESTEPHG Test JPL ephemeris file reading and interpolation
%    TESTEPHG(EFILE,TFILE) compares the results generated by reading
%    and interpolating the data in the binary ephemeris file EFILE
%    to the results from the ASCII test file TFILE.  The success
%    criterion is a difference of less than 1e-13.  A plot of the
%    difference is generated along with a message regarding test
%    success.
%
%    NOTE:  Some large libration values may be stored incorrectly
%    due to the number of significant digits involved.  Check any
%    errors in libration (NTARG=15) by comparing the 'Calculated
%    Result' column of the output against the reference value in
%    the ORIGINAL test file TFILE.

% Read the test data and initialize the ephemeris file

eph_global
testdat=read_testpo(tfile);
init_eph(efile)

ncases=size(testdat,1);

rpt=[]; % Reporting string

% Report how many cases were loaded and how many will be tested

rpt=strvcat(rpt, ...
    sprintf('%i cases loaded with Julian dates from %f to %f ...', ...
    ncases,min(testdat(:,1)),max(testdat(:,1))));

keep=find(testdat(:,1)>=SST(1) & testdat(:,1)<=SST(2));
testdat=testdat(keep,:);
ncases=size(testdat,1);

rpt=strvcat(rpt, ...
    sprintf('%i cases will be compared ...',size(keep,1))); 

% Pre-allocate variables for error and results

err=zeros(size(testdat,1),1);
result=zeros(size(testdat,1),1);

% Set up graphical progress bar

hp=progressbar('Test cases completed');

% For each case, interpolate the ephemeris and compare results

for i=1:ncases
    [r,v]=pleph(testdat(i,1),testdat(i,2),testdat(i,3),0);
    s=[r(:);v(:)];
    err(i)=s(testdat(i,4))-testdat(i,5);
    result(i)=s(testdat(i,4));
    if ~mod(i,200)
        pct=round(i/ncases*100);
        set(hp.hr,'XData',[0 pct pct 0],'YData',get(hp.hr,'YData'))
        set(hp.ht,'String',sprintf('%3i%%',pct))
        drawnow
%        disp(sprintf('%5i cases completed ...',i)) % Report progress
    end
end

delete(hp.hf)

% Set the tolerance and report success or detail failures

tol=1e-13;
ierr=find(abs(err)>tol);
if isempty(ierr)
    rpt=strvcat(rpt, ...
        sprintf('All %i cases passed.  All errors are <= %5.0e',ncases,tol));
else
    rpt=strvcat(rpt, ...
        sprintf('The following cases had errors > %5.0e',tol));
    rpt=strvcat(rpt, ...
        sprintf(' Case  Julian Date   ntarg ncent  dim    Reference Result    Calculated Result       Error'));
    rpt=strvcat(rpt, ...
        sprintf('----------------------------------------------------------------------------------------------'));
    for i=1:size(ierr(:),1)
        rpt=strvcat(rpt, ...
            sprintf('%5i %12.2f %5i %5i %5i %20.13f %20.13f %15.4e', ...
            [ierr(i) testdat(ierr(i),:) result(ierr(i)) err(ierr(i))]'));
    end
    rpt=strvcat(rpt,' ');
    rpt=strvcat(rpt,sprintf('%s\n','NOTE:  Some large libration values may be stored incorrectly'));
    rpt=strvcat(rpt,sprintf('%s\n','due to the number of significant digits involved.  Check any'));
    rpt=strvcat(rpt,sprintf('%s\n','errors in libration (NTARG=15) by comparing the CALCULATED'));
    rpt=strvcat(rpt,sprintf('%s\n','RESULT column of the output against the reference value in'));
    rpt=strvcat(rpt,sprintf('the test file %s.\n',tfile));

end

tt=testdat(:,1);